#' Activate dark mode on a ggplot2 theme
#'
#' @param .theme ggplot2 theme object
#' @param verbose print messages (default: TRUE)
#' @param force_geom_invert Force the inversion of geom defaults for fill and color/colour (default: FALSE)
#'
#' @return dark version of theme
#'
#' @importFrom ggplot2 theme theme_get is.theme element_rect
#' @export
#'
#' @examples
#' library(ggplot2)
#'
#' p1 <- ggplot(iris, aes(Sepal.Width, Sepal.Length, color = Species)) +
#'   geom_point()
#'
#' p1  # theme_gray(), the default
#' p1 + dark_mode()  # activate dark mode on theme_gray()
#'
#' p2 <- ggplot(iris, aes(Sepal.Width, Sepal.Length)) +
#'   geom_point() +
#'   facet_wrap(~ Species)
#'
#' p2 + dark_mode(theme_minimal())  # activate dark mode on another theme
#'
#' invert_geom_defaults()  # restore geom defaults to their original values
#' @rdname dark_mode
#' @export
dark_mode <- function(.theme = theme_get(), verbose = TRUE, force_geom_invert = FALSE) {
  stopifnot(is.theme(.theme))
  geoms <- get_geoms()
  # Detect whether the default value of geom point colour is black. If so, it is likely that
  # all geom defaults must be inverted, otherwise leave the geoms alone unless force_geom_invert.
  geoms_not_inverted <- geoms[["GeomPoint"]]$default_aes$colour %in% c("black", "#000000")
  if (geoms_not_inverted || force_geom_invert) {
    invert_geom_defaults(geoms)
    if (verbose) {
      message("Inverted geom defaults of fill and color/colour.\n",
              "To change them back, use invert_geom_defaults().")
    }
  }
  .theme <- invert_theme_elements(.theme)
  if (inherits(.theme$plot.background, "element_blank") | is.null(.theme$plot.background)) {
    # For a few themes, like theme_minimal and theme_void from ggplot2, the background
    # is blank or NULL and displays as white, so fill the plot background with black.
    .theme <- .theme + theme(plot.background = element_rect(fill = "#000000"))
  }
  .theme
}

#' Invert theme elements
#'
#' @param .theme theme to invert
#'
#' @importFrom ggplot2 is.theme
#'
#' @return Inverted theme
#'
#' @export
#' @rdname invert_theme_elements
invert_theme_elements <- function(.theme) {
  stopifnot(is.theme(.theme))
  for (element_name in names(.theme)) {
    element <- .theme[[element_name]]
    if (inherits(element, "element")) {  # element_line, element_rect, element_text, element_blank
      if (!is.null(element$colour)) {
        .theme[[element_name]]$colour <- invert_color(element$colour)
      }
      if (!is.null(element$fill)) {
        .theme[[element_name]]$fill <- invert_color(element$fill)
      }
    }
  }
  .theme
}


#' Inverse geom defaults for fill and color/colour
#'
#' @param geoms List of geoms as ggproto objects
#'
#' @importFrom ggplot2 is.ggproto
#'
#' @examples
#' library(ggplot2)
#'
#' p <- ggplot(iris, aes(Sepal.Width, Sepal.Length)) +
#'   geom_point() +
#'   facet_wrap(~ Species)
#'
#' old <- theme_set(dark_mode())  # color and fill changed to "white"
#' p
#'
#' update_geom_colors(color = "grey80", fill = "grey80")  # or perhaps a light grey
#' p
#'
#' theme_set(old)
#' p  # oh no! geom defaults are still "white"
#'
#' update_geom_colors()  # color and fill changed to "black"
#' p  # back to normal
#'
#' @export
#' @rdname invert_geom_defaults
invert_geom_defaults <- function(geoms = get_geoms()) {
  for (geom in geoms) {
    stopifnot(is.ggproto(geom))
    if (!is.null(geom$default_aes$fill)) {
      geom$default_aes$fill <- invert_color(geom$default_aes$fill)
    }
    if (!is.null(geom$default_aes$colour)) {
      geom$default_aes$colour <- invert_color(geom$default_aes$colour)
    }
  }
  invisible()
}

#' @export
#' @keywords internal
get_geoms <- function() {
  geom_names <- apropos("^Geom", ignore.case = FALSE)
  geoms <- list()
  for (namespace in loadedNamespaces()) {
    namespace_geoms <- mget(geom_names, envir = asNamespace(namespace), ifnotfound = list(NULL))
    for (geom_name in geom_names) {
      if (is.ggproto(namespace_geoms[[geom_name]])) {
        geoms[[geom_name]] <- namespace_geoms[[geom_name]]
      }
    }
  }
  geoms
}


#' Invert color(s)
#'
#' Invert a vector of colors, provided the colors are valid hex codes
#' or have valid names (i.e., they belong to [base::colors()]), and
#' return a vector of inverted colors in hex code.
#'
#' @param color color(s) to invert
#' @param colour alias of color
#'
#' @return Inverted color(s) in hex code
#'
#' @importFrom grDevices col2rgb rgb
#'
#' @examples
#' invert_color("white")    # "black"
#' invert_color("gray20")   # "gray80"
#' invert_color("grey80")   # "grey20"
#' invert_color(c("#000000", "#333333"))  # "#FFFFFF","#CCCCCC"
#'
#' @export
#' @rdname invert_color
invert_color <- function(color, colour = color) {
  inv_rgb <- abs(255 - col2rgb(colour))
  inv_color <- rgb(inv_rgb[1, ], inv_rgb[2, ], inv_rgb[3, ], maxColorValue = 255)
  inv_color[is.na(colour)] <- NA
  inv_color[is.null(colour)] <- NULL
  inv_color
}

#' @export
#' @rdname invert_color
invert_colour <- invert_color
